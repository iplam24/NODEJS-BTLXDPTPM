const {switchRed} = require('../migration/userRole');
const { addCarDB,getAllCar } = require('../models/productDAO');
const {getUserAccount,checkUser,createUser,getUserRole} = require('../models/userDAO');
//lay ve trang chu
const getHomePage =async (req,res)=>{
    // try {
    //     let pool = await connectDB();
    //     let result = await pool.request().query('SELECT * FROM tbl_users');
    //     console.log('‚úÖ D·ªØ li·ªáu t·ª´ database:', result.recordset);
    //     res.send(result.recordsets);
    // } catch (err) {
    //     res.send('L·ªói k·∫øt n·ªëi database');
    // }
    res.render('MainPage');
}

const logInserver=async(req,res)=>{
    let usernameLogin = req.body.usernameLogin;
    let passwordLogin = req.body.passwordLogin;
 
     //Ki·ªÉm tra xem t√†i kho·∫£n v√† m·∫≠t kh·∫©u c√≥ ƒë·ªÉ tr·ªëng hay kh√¥ng
    if (!usernameLogin || !passwordLogin) {
     return res.send(`<script>
         alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
         window.location.href = "/dangnhap"; 
     </script>`);
    }
    try{
        let user = await getUserAccount(usernameLogin,passwordLogin);
        if(!user){
            return res.render("login",{
                message:"T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!",
                oldData:{usernameLogin}
            });
        }

        //l·∫•y v·ªÅ role c·ªßa userLogin
        let role = await getUserRole(usernameLogin);
        if(role==null){
            return render("login",{
                message:"Kh√¥ng t√¨m th·∫•y vai tr√≤ c·ªßa t√†i kho·∫£n n√†y!",
                oldData:{usernameLogin}
            });
        }

        //Th√¥ng b√°o v·ªÅ server
        console.log(`User "${usernameLogin}" ƒëƒÉng nh·∫≠p v·ªõi vai tr√≤ - ${role}`);

        //l∆∞u session
        req.session.user={usernameLogin,role};
        
        switchRed(role,usernameLogin,res);
        
        } catch (err) {
            console.error("‚ö† L·ªói h·ªá th·ªëng:", err);
            return res.send(`<script>
                alert("L·ªói h·ªá th·ªëng! Vui l√≤ng th·ª≠ l·∫°i.");
                window.location.href = "/dangnhap";
            </script>`);
        };
    }

 
 const postCreateNewUser = async(req,res)=>{
    let { username, password, repassword, myname, email, phone, address } = req.body;
    // Ki·ªÉm tra d·ªØ li·ªáu nh·∫≠p v√†o
    if (!username || !password || !repassword) {
        return res.render("signup", { 
            message: "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!", 
            oldData: { username, myname, email, phone, address } 
        });
    }

    if (password !== repassword) {
        return res.render("signup", { 
            message: "M·∫≠t kh·∫©u kh√¥ng tr√πng kh·ªõp!", 
            oldData: { username, myname, email, phone, address } 
        });
    }

    try {
        // Ki·ªÉm tra username ƒë√£ t·ªìn t·∫°i ch∆∞a
        let userExists = await checkUser(username);
        if (userExists) {
            return res.render("signup", { 
                message: "T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i, vui l√≤ng s·ª≠ d·ª•ng t√†i kho·∫£n kh√°c!", 
                oldData: { username, myname, email, phone, address } 
            });
        }
         // T·∫°o ng∆∞·ªùi d√πng m·ªõi
         await createUser(username, password, myname, email, phone, address,2);
         console.log("‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng ng∆∞·ªùi d√πng m·ªõi:", username);
 
         return res.send(`<script>
             alert("ƒêƒÉng k√Ω t√†i kho·∫£n th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p");
             window.location.href = "/dangnhap"; 
         </script>`);
    }catch (err) {
    console.error("‚ö† L·ªói h·ªá th·ªëng:", err);
    return res.send(`<script>
        alert("L·ªói h·ªá th·ªëng! Vui l√≤ng th·ª≠ l·∫°i.");
        window.location.href = "/dangky"; 
    </script>`);
}
}
const getCar=async(req,res)=>{
    try {
        const cars = await getAllCar();
        res.render("sanpham", { cars });  // üü¢ Truy·ªÅn d·ªØ li·ªáu xe v√†o view
    } catch (error) {
        console.error("‚ùå L·ªói khi hi·ªÉn th·ªã danh s√°ch xe:", error);
        res.status(500).send("L·ªói khi hi·ªÉn th·ªã danh s√°ch xe");
    }
}
module.exports={logInserver,getHomePage,postCreateNewUser,getCar}